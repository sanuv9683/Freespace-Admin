<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Data Entry</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Enter Device Data</h2>
    <form id="dataForm">
        <div class="form-group">
            <label for="markerID">Marker ID</label>
            <input type="text" class="form-control" id="markerID" required>
        </div>
        <div class="form-group">
            <label for="deviceID">Device ID</label>
            <input type="text" class="form-control" id="deviceID" required>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    <div id="response" class="mt-3"></div>
</div>

<!-- Google Identity Services library -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Google API client library -->
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

<!--<script>-->
<!--    // Your Google API Client ID and API Key-->
<!--    const CLIENT_ID = '936125713810-vllc3mt30976jfllsg3i40ak55lofvl1.apps.googleusercontent.com';-->
<!--    const API_KEY = 'AIzaSyCsWAr78ZezVoY0xgLQj8K-K6dJuR_McSc';-->

<!--    // Google Sheets ID and range where data will be saved-->
<!--    const SPREADSHEET_ID = '1Mifn_2UvP5N7cxY9p0guNeU97yDHGBTCRrdT9bXY-I8';-->
<!--    const SHEET_NAME = 'Sheet1';-->

<!--    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';-->

<!--    // Load the auth2 library-->
<!--    function handleClientLoad() {-->
<!--        gapi.load('client:auth2', initClient);-->
<!--    }-->

<!--    // Initialize the API client library and set up sign-in state listeners-->
<!--    function initClient() {-->
<!--        gapi.client.init({-->
<!--            apiKey: API_KEY,-->
<!--            clientId: CLIENT_ID,-->
<!--            scope: SCOPES-->
<!--        }).then(() => {-->
<!--            console.log("GAPI client initialized.");-->
<!--        });-->
<!--    }-->

<!--    // Handle the form submission-->
<!--    document.getElementById('dataForm').addEventListener('submit', async function (e) {-->
<!--        e.preventDefault();-->

<!--        const markerID = document.getElementById('markerID').value;-->
<!--        const deviceID = document.getElementById('deviceID').value;-->

<!--        if (gapi.auth2.getAuthInstance().isSignedIn.get()) {-->
<!--            saveDataToSheet(markerID, deviceID);-->
<!--        } else {-->
<!--            gapi.auth2.getAuthInstance().signIn().then(() => {-->
<!--                saveDataToSheet(markerID, deviceID);-->
<!--            });-->
<!--        }-->
<!--    });-->

<!--    // Function to save data to Google Sheets-->
<!--    function saveDataToSheet(markerID, deviceID) {-->
<!--        const params = {-->
<!--            spreadsheetId: SPREADSHEET_ID,-->
<!--            range: `${SHEET_NAME}!A:B`,-->
<!--            valueInputOption: 'USER_ENTERED'-->
<!--        };-->

<!--        const valueRangeBody = {-->
<!--            majorDimension: "ROWS",-->
<!--            values: [[markerID, deviceID]]-->
<!--        };-->

<!--        gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody)-->
<!--            .then(response => {-->
<!--                if (response.status === 200) {-->
<!--                    document.getElementById('response').innerHTML = `<div class="alert alert-success">Data saved successfully!</div>`;-->
<!--                    document.getElementById('dataForm').reset();-->
<!--                } else {-->
<!--                    document.getElementById('response').innerHTML = `<div class="alert alert-danger">Failed to save data.</div>`;-->
<!--                }-->
<!--            }, error => {-->
<!--                document.getElementById('response').innerHTML = `<div class="alert alert-danger">Error: ${error.result.error.message}</div>`;-->
<!--            });-->
<!--    }-->

<!--    // Load the client on window load-->
<!--    window.onload = function () {-->
<!--        handleClientLoad();-->
<!--    };-->

<!--</script>-->

<script>
    // Your Google API Client ID and API Key
    const CLIENT_ID = '936125713810-vllc3mt30976jfllsg3i40ak55lofvl1.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCsWAr78ZezVoY0xgLQj8K-K6dJuR_McSc';

    // Google Sheets ID and range where data will be saved
    const SPREADSHEET_ID = '1Mifn_2UvP5N7cxY9p0guNeU97yDHGBTCRrdT9bXY-I8';
    const SHEET_NAME = 'Sheet1';

    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // Load the GAPI client library
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        });
        gapiInited = true;
        maybeEnableForm();
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        maybeEnableForm();
    }

    function maybeEnableForm() {
        if (gapiInited && gisInited) {
            document.getElementById('dataForm').style.display = 'block';
        }
    }

    document.getElementById('dataForm').addEventListener('submit', function (e) {
        e.preventDefault();
        if (gapi.client.getToken() === null) {
            tokenClient.callback = async (response) => {
                if (response.error) {
                    throw response;
                }
                await saveDataToSheet();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            saveDataToSheet();
        }
    });

    async function saveDataToSheet() {
        const markerID = document.getElementById('markerID').value;
        const deviceID = document.getElementById('deviceID').value;

        const params = {
            spreadsheetId: SPREADSHEET_ID,
            range: `${SHEET_NAME}!A:B`,
            valueInputOption: 'USER_ENTERED',
        };

        const valueRangeBody = {
            majorDimension: "ROWS",
            values: [[markerID, deviceID]],
        };

        try {
            const response = await gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
            if (response.status === 200) {
                document.getElementById('response').innerHTML = `<div class="alert alert-success">Data saved successfully!</div>`;
                document.getElementById('dataForm').reset();
            }
        } catch (error) {
            document.getElementById('response').innerHTML = `<div class="alert alert-danger">Error: ${error.result.error.message}</div>`;
        }
    }

    // Load the GAPI and GIS libraries when the window loads
    window.onload = function () {
        gapiLoaded();
        gisLoaded();
    };

</script>
</body>
</html>
